
---
title: "Metro Melbourne COVID-19 2023 survey; Census 2016 & 2021 residential relocation"
runningheader: "Metro Melbourne COVID-19 2023 survey; Census 2016 & 2021 residential relocation" # only for pdf output
subtitle: "Data analysis" # only for html output
author: "Dr James Reynolds, Public Transport Research Group (PTRG), Monash University"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: 
    margin_references: false
    citation_package: natbib
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
bibliography: skeleton.bib
link-citations: yes
---

```{r setup, include=FALSE}
library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
require(RColorBrewer)
```


# 1.0 Introduction
As part of the work program for the upcoming Metro Melbourne COVID-19 2023 (second) survey PTRG is comparing the usual place of residence results from the 2016 and 2021 Australian census. The analysis includes looking at Metro Melbourne as a whole, and also the inner, middle and outer regions individually^[With those regions being as defined in the 2020 (first) survey.], as well as the Peri-Urban Area and Rest of Victoria regions that will be used for the forthcoming Regional Victoria COVID-19 2023 survey. 

This work note summarises the analysis and findings. The next section discusses the datasets retrieved from the Australian Bureau of Statistics (ABS) Table Builder. Section 3 shows the regions used in the 2020 (first) survey and this analysis. Section 4 presents the analysis results.


# 2.0 Data 
Sixteen datasets were extracted as Comma-Separated Values (CSV) files using the ABS Table Builder online system. The first eight datasets were the results for Victorian residents by Local Government Area for the questions about usual place of residence 1 year ago and 5 years ago^[Specifically the Place of Usual Residence one year ago (PUR1P) and Place of Usual Residence five years ago (PUR5P) variables.  Details are avaiable at https://www.abs.gov.au/census/guide-census-data/census-dictionary/2021/variables-topic/location/place-usual-residence-one-year-ago-pur1p], with data retrieved for the 2016 and 2021 censuses. Separate tables were extracted for respondents who answered that their previous place of residence was within a specific Victorian LGA, and for those whose previous place of residence was in another state or territory. Examples from the data tables are shown below in Tables 1 and 2^[Some minor edits were made directly to the CSV files prior to importation into R. This includes fixing the LGA name fields, which were inconsistent. The 2016 version also showed the type of LGA, (Shire, Regional City or City) as letters (S, RC, C) in brackets. The 2021 CSV files were updated to adopt the 2016 approach.]. 

```{r loadsurveydata, echo=FALSE, warning = FALSE, message = FALSE, include = TRUE} 
#Load datasets
library(readr)
X2016_1yr_ago_State <- read_csv("01 data/2016_1yr_ago_State.csv", skip = 8)
X2016_1yr_ago_Vic_LGA <- read_csv("01 data/2016_1yr_ago_Vic_LGA.csv", skip = 8)
X2016_5yr_ago_State <- read_csv("01 data/2016_5yr_ago_State.csv", skip = 8)
X2016_5yr_ago_Vic_LGA <- read_csv("01 data/2016_5yr_ago_Vic_LGA.csv", skip = 8)
X2021_1yr_ago_State <- read_csv("01 data/2021_1yr_ago_State.csv", skip = 9)
X2021_1yr_ago_Vic_LGA <- read_csv("01 data/2021_1yr_ago_Vic_LGA.csv", skip = 9)
X2021_5yr_ago_State <- read_csv("01 data/2021_5yr_ago_State.csv", skip = 9)
X2021_5yr_ago_Vic_LGA <- read_csv("01 data/2021_5yr_ago_Vic_LGA.csv", skip = 9)



#delete empty first rows from each table
X2016_1yr_ago_State <- X2016_1yr_ago_State[-1,]
X2016_1yr_ago_Vic_LGA <- X2016_1yr_ago_Vic_LGA[-1,]
X2016_5yr_ago_State <- X2016_5yr_ago_State[-1,]
X2016_5yr_ago_Vic_LGA <- X2016_5yr_ago_Vic_LGA[-1,]
X2021_1yr_ago_State <- X2021_1yr_ago_State[-1,]
X2021_1yr_ago_Vic_LGA <- X2021_1yr_ago_Vic_LGA[-1,]
X2021_5yr_ago_State <- X2021_5yr_ago_State[-1,]
X2021_5yr_ago_Vic_LGA <- X2021_5yr_ago_Vic_LGA[-1,]

#delete empty last column from each table
#delete total column from each table
#also delete Not Stated, and Not Applicable; from State tables
#also delete: Capital City Undefined (Greater Melbourne),	Unincorporated Vic,	No Usual Address (Vic.),	Migratory - Offshore - Shipping (Vic.), and	State Undefined (Vic.); from LGA tables
X2016_1yr_ago_State <- X2016_1yr_ago_State[,1:(ncol(X2016_1yr_ago_State)-4)]
X2016_1yr_ago_Vic_LGA <- X2016_1yr_ago_Vic_LGA[,1:(ncol(X2016_1yr_ago_Vic_LGA)-7)]
X2016_5yr_ago_State <- X2016_5yr_ago_State[,1:(ncol(X2016_5yr_ago_State)-4)]
X2016_5yr_ago_Vic_LGA <- X2016_5yr_ago_Vic_LGA[,1:(ncol(X2016_5yr_ago_Vic_LGA)-7)]
X2021_1yr_ago_State <- X2021_1yr_ago_State[,1:(ncol(X2021_1yr_ago_State)-3)]
X2021_1yr_ago_Vic_LGA <- X2021_1yr_ago_Vic_LGA[,1:(ncol(X2021_1yr_ago_Vic_LGA)-6)]
X2021_5yr_ago_State <- X2021_5yr_ago_State[,1:(ncol(X2021_5yr_ago_State)-3)]
X2021_5yr_ago_Vic_LGA <- X2021_5yr_ago_Vic_LGA[,1:(ncol(X2021_5yr_ago_Vic_LGA)-6)]

#delete last 3 to 4 rows from each table, as they contain ABS notes etc. 
#Also remove total row, 
#Also remove Unincorporated Vic, No usual address (Vic.) and 	Migratory - Offshore - Shipping (Vic.) rows as these are small and special cases that we do not need to include in this analysis 
X2016_1yr_ago_State <- head(X2016_1yr_ago_State,-8)
X2016_1yr_ago_Vic_LGA <- head(X2016_1yr_ago_Vic_LGA,-8)
X2016_5yr_ago_State <- head(X2016_5yr_ago_State,-8)
X2016_5yr_ago_Vic_LGA <- head(X2016_5yr_ago_Vic_LGA,-8)
X2021_1yr_ago_State <- head(X2021_1yr_ago_State,-11)
X2021_1yr_ago_Vic_LGA <- head(X2021_1yr_ago_Vic_LGA,-11)
X2021_5yr_ago_State <- head(X2021_5yr_ago_State,-11)
X2021_5yr_ago_Vic_LGA <- head(X2021_5yr_ago_Vic_LGA,-11)

#Convert second column to numeric, as it is a character for some reason
X2016_1yr_ago_State$`New South Wales` <- as.numeric(X2016_1yr_ago_State$`New South Wales`)
X2016_1yr_ago_Vic_LGA$`Alpine (S)` <- as.numeric(X2016_1yr_ago_Vic_LGA$`Alpine (S)`)
X2016_5yr_ago_State$`New South Wales` <- as.numeric(X2016_5yr_ago_State$`New South Wales`)
X2016_5yr_ago_Vic_LGA$`Alpine (S)` <- as.numeric(X2016_5yr_ago_Vic_LGA$`Alpine (S)`)
X2021_1yr_ago_State$`New South Wales` <- as.numeric(X2021_1yr_ago_State$`New South Wales`)
X2021_1yr_ago_Vic_LGA$`Alpine (S)` <- as.numeric(X2021_1yr_ago_Vic_LGA$`Alpine (S)`)
X2021_5yr_ago_State$`New South Wales` <- as.numeric(X2021_5yr_ago_State$`New South Wales`)
X2021_5yr_ago_Vic_LGA$`Alpine (S)` <- as.numeric(X2021_5yr_ago_Vic_LGA$`Alpine (S)`)

#change name of first column in all dataframes to LGA
df.list <- list(X2016_1yr_ago_State, X2016_1yr_ago_Vic_LGA, X2016_5yr_ago_State, X2016_5yr_ago_Vic_LGA, X2021_1yr_ago_State, X2021_1yr_ago_Vic_LGA, X2021_5yr_ago_State, X2021_5yr_ago_Vic_LGA)
res <- lapply(df.list, function(x) {colnames(x)[1] = "LGA"; x})
names(res) <- c("X2016_1yr_ago_State", "X2016_1yr_ago_Vic_LGA", "X2016_5yr_ago_State", "X2016_5yr_ago_Vic_LGA", "X2021_1yr_ago_State", "X2021_1yr_ago_Vic_LGA", "X2021_5yr_ago_State", "X2021_5yr_ago_Vic_LGA")
invisible(list2env(res,envir=.GlobalEnv))


knitr::kable(
  head(X2016_1yr_ago_State), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrrr", caption = 'Table 1: 2016 census, State/Territory of Usual Residence one year ago (PUR1P), results by LGA for Victoria, first 6 results')

#knitr::kable(
#  head(rowSums(X2016_1yr_ago_State[,2:ncol(X2016_1yr_ago_State)])), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrr", caption = 'Table 1a: 2016 census, State/Territory of Usual Residence one year ago (PUR1P), results by LGA for Victoria, row sums, first 6 results')
####This was just to check that the rows added up correctly. 

knitr::kable(
  head(X2016_1yr_ago_Vic_LGA[,1:11]), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrrr", caption = 'Table 2: 2016 census, LGA of Usual Residence one year ago (PUR1P), results by LGA for Victoria, first 6 results')


#knitr::kable(
#  head(rowSums(X2016_1yr_ago_Vic_LGA[,2:ncol(X2016_1yr_ago_Vic_LGA)])), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrr", caption = 'Table 2a: 2016 census, LGA of Usual Residence one year ago (PUR1P), results by LGA for Victoria, row sums, first 6 results')
####This was just to check that the rows added up correctly.  In general, the sum here (10,743 for Apline) is close to matching the Victoria entry in Table 1 (10,802). Minor differences expect due to randomisation of ABS tables, and removal of Melbourne not specified, missing etc. 


```

The Place of Usual Residence (PURP1P, PUR5P) variables from the ABS datasets includes people who did not move in the values shown for each LGA and State/Territory.  Therefore a further four^[Running total is 8+4=12 of 16] datasets were extracted for the Usual address one year ago indicator (UAI1P) and Usual address five years ago indicator (UAI5P)^[See details at https://www.abs.gov.au/census/guide-census-data/census-dictionary/2021/variables-topic/location/usual-address-one-year-ago-indicator-uai1p. As an example, the 10,359 people from Alpine Shire in 2016 whose place of usual residence was (also) within Alpine Shire one year prior to the 2016 census (from Table 2) consist of 9,711 who had not moved house (see Table 3) and 648 who had moved house, but to somewhere else within the Alpine Shire (as 10,359-9,711-648.] were also extracted using the ABS Table Builder tool^{Again, some minor edits were made directly to the CSV files prior to importation into R]. An example of the UAI1P data table is shown below in Table 3. 


```{r load_place_indicator, echo=FALSE, warning = FALSE, message = FALSE, include = TRUE} 
#Load datasets
library(readr)
X2016_usual_address_1yr_ago_indicator <- read_csv("01 data/2016_usual_address_1yr_ago_indicator.csv", skip = 8)
X2016_usual_address_5yr_ago_indicator <- read_csv("01 data/2016_usual_address_5yr_ago_indicator.csv", skip = 8)
X2021_usual_address_1yr_ago_indicator <- read_csv("01 data/2021_usual_address_1yr_ago_indicator.csv", skip = 9)
X2021_usual_address_5yr_ago_indicator <- read_csv("01 data/2021_usual_address_5yr_ago_indicator.csv", skip = 9)



#delete empty first rows from each table
X2016_usual_address_1yr_ago_indicator <- X2016_usual_address_1yr_ago_indicator[-1,]
X2016_usual_address_5yr_ago_indicator <- X2016_usual_address_5yr_ago_indicator[-1,]
X2021_usual_address_1yr_ago_indicator <- X2021_usual_address_1yr_ago_indicator[-1,]
X2021_usual_address_5yr_ago_indicator <- X2021_usual_address_5yr_ago_indicator[-1,]

#delete empty last column from 2016 table
#delete total column from each table
X2016_usual_address_1yr_ago_indicator <- X2016_usual_address_1yr_ago_indicator[,1:(ncol(X2016_usual_address_1yr_ago_indicator)-2)]
X2016_usual_address_5yr_ago_indicator <- X2016_usual_address_5yr_ago_indicator[,1:(ncol(X2016_usual_address_5yr_ago_indicator)-2)]
X2021_usual_address_1yr_ago_indicator <- X2021_usual_address_1yr_ago_indicator[,1:(ncol(X2021_usual_address_1yr_ago_indicator)-1)]
X2021_usual_address_5yr_ago_indicator <- X2021_usual_address_5yr_ago_indicator[,1:(ncol(X2021_usual_address_5yr_ago_indicator)-1)]


#delete last 3 to 4 rows from each table, as they contain ABS notes etc. 
#Also remove total row, 
#Also remove Unincorporated Vic, No usual address (Vic.) and 	Migratory - Offshore - Shipping (Vic.) rows as these are small and special cases that we do not need to include in this analysis 
X2016_usual_address_1yr_ago_indicator <- head(X2016_usual_address_1yr_ago_indicator,-8)
X2016_usual_address_5yr_ago_indicator <- head(X2016_usual_address_5yr_ago_indicator,-8)
X2021_usual_address_1yr_ago_indicator <- head(X2021_usual_address_1yr_ago_indicator,-11)
X2021_usual_address_5yr_ago_indicator <- head(X2021_usual_address_5yr_ago_indicator,-11)

#Convert second column to numeric, as it is a character for some reason
X2016_usual_address_1yr_ago_indicator$`Same as in 2016` <- as.numeric(X2016_usual_address_1yr_ago_indicator$`Same as in 2016`)
X2016_usual_address_5yr_ago_indicator$`Same as in 2016` <- as.numeric(X2016_usual_address_5yr_ago_indicator$`Same as in 2016`)
X2021_usual_address_1yr_ago_indicator$`Same as in 2021` <- as.numeric(X2021_usual_address_1yr_ago_indicator$`Same as in 2021`)
X2021_usual_address_5yr_ago_indicator$`Same as in 2021` <- as.numeric(X2021_usual_address_5yr_ago_indicator$`Same as in 2021`)

#change name of first column in all dataframes to LGA
df.list <- list(X2016_usual_address_1yr_ago_indicator, X2016_usual_address_5yr_ago_indicator, X2021_usual_address_1yr_ago_indicator, X2021_usual_address_5yr_ago_indicator)
df.list <- lapply(df.list, function(x) {colnames(x)[1] = "LGA"; x})
names(df.list) <- c("X2016_usual_address_1yr_ago_indicator", "X2016_usual_address_5yr_ago_indicator", "X2021_usual_address_1yr_ago_indicator", "X2021_usual_address_5yr_ago_indicator")
invisible(list2env(df.list,envir=.GlobalEnv))


knitr::kable(
  head(X2016_usual_address_1yr_ago_indicator), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrr", caption = 'Table 3: 2016 census, Usual Address one year ago Indicator (UAI1P), results by LGA for Victoria, first 6 results')

#knitr::kable(
#  head(rowSums(X2016_usual_address_1yr_ago_indicator[,2:ncol(X2016_usual_address_1yr_ago_indicator)])), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrr", caption = 'Table 3a: 2016 census, Usual Address one year ago Indicator (UAI1P), results by LGA for Victoria, row sums, first 6 results')
###Just checking totals again.  All good as Apline total (12,331) minus the Not Stated and Not applicables (1,107+94=1,201) matches the Table 1a total

```

Combining the tables (PUR1P by State and by LGA, and UAI1P) gives a single table for each census and time period^[2016 and 2021 census; 1 year ago and 5 years ago]. Table 4 shows an example of the combined tables. 

```{r same_as_in_to_seperate_column, echo=FALSE, warning=FALSE, message=FALSE, include = TRUE} 

#Move State dataframes  in list
df.State.list <- list(X2016_1yr_ago_State, X2016_5yr_ago_State, X2021_1yr_ago_State,  X2021_5yr_ago_State)
names(df.State.list) <- c("X2016_1yr_ago_State", "X2016_5yr_ago_State", "X2021_1yr_ago_State", "X2021_5yr_ago_State")
#remove Victoria column from State dataframes list
df.State.list <- lapply(df.State.list, function(x) {x[-c(3)]})
#return State dataframes out of list
invisible(list2env(df.State.list,envir=.GlobalEnv))


#Move LGA dataframes  in list
df.LGA.list <- list(X2016_1yr_ago_Vic_LGA, X2016_5yr_ago_Vic_LGA, X2021_1yr_ago_Vic_LGA,  X2021_5yr_ago_Vic_LGA)
names(df.LGA.list) <- c("X2016_1yr_ago_Vic_LGA", "X2016_5yr_ago_Vic_LGA", "X2021_1yr_ago_Vic_LGA", "X2021_5yr_ago_Vic_LGA")


#Move usual address indicator dataframes  in list
df.usual_address.list <- list(X2016_usual_address_1yr_ago_indicator, X2016_usual_address_5yr_ago_indicator, X2021_usual_address_1yr_ago_indicator,  X2021_usual_address_5yr_ago_indicator)
names(df.LGA.list) <- c("X2016_usual_address_1yr_ago_indicator", "X2016_usual_address_5yr_ago_indicator", "X2021_usual_address_1yr_ago_indicator", "X2021_usual_address_5yr_ago_indicator")






#merge dataframes 2016 1 yr ago
X2016_combined_1yr_ago <- merge(X2016_usual_address_1yr_ago_indicator, X2016_1yr_ago_Vic_LGA, by.x = "LGA", by.y = "LGA")
X2016_combined_1yr_ago <- merge(X2016_combined_1yr_ago, X2016_1yr_ago_State, by.x = "LGA", by.y = "LGA")
#merge dataframes 2016 5 yr ago
X2016_combined_5yr_ago <- merge(X2016_usual_address_5yr_ago_indicator, X2016_5yr_ago_Vic_LGA, by.x = "LGA", by.y = "LGA")
X2016_combined_5yr_ago <- merge(X2016_combined_5yr_ago, X2016_5yr_ago_State, by.x = "LGA", by.y = "LGA")

#merge dataframes 2021 1 yr ago
X2021_combined_1yr_ago <- merge(X2021_usual_address_1yr_ago_indicator, X2021_1yr_ago_Vic_LGA, by.x = "LGA", by.y = "LGA")
X2021_combined_1yr_ago <- merge(X2021_combined_1yr_ago, X2021_1yr_ago_State, by.x = "LGA", by.y = "LGA")
#merge dataframes 2021 5 yr ago
X2021_combined_5yr_ago <- merge(X2021_usual_address_5yr_ago_indicator, X2021_5yr_ago_Vic_LGA, by.x = "LGA", by.y = "LGA")
X2021_combined_5yr_ago <- merge(X2021_combined_5yr_ago, X2021_5yr_ago_State, by.x = "LGA", by.y = "LGA")


#remove duplicated last (Overseas) columns from each dataframe
X2016_combined_1yr_ago <- X2016_combined_1yr_ago[,1:(ncol(X2016_combined_1yr_ago)-1)]
X2016_combined_5yr_ago <- X2016_combined_5yr_ago[,1:(ncol(X2016_combined_5yr_ago)-1)]
X2021_combined_1yr_ago <- X2021_combined_1yr_ago[,1:(ncol(X2021_combined_1yr_ago)-1)]
X2021_combined_5yr_ago <- X2021_combined_5yr_ago[,1:(ncol(X2021_combined_5yr_ago)-1)]


#write function to subtract the "Same as in YYYY" column from the relevant LGA column for each (LGA) row
function.subtract_same_as_in_YYYY_column <- function(df){
for (i in 1:nrow(df)){
    LGA_name <- df[i,1]
    same_location_number <- df[i,2]
    column_number_of_LGA_name <- which(colnames(df)==LGA_name)
df[i,column_number_of_LGA_name] <- df[i,column_number_of_LGA_name]-same_location_number
  }
return(df)}

#Move combined dataframes  into list
df.combined_by_LGA.list <- list(X2016_combined_1yr_ago, X2016_combined_5yr_ago, X2021_combined_1yr_ago,  X2021_combined_5yr_ago)
names(df.combined_by_LGA.list) <- c("X2016_combined_1yr_ago", "X2016_combined_5yr_ago", "X2021_combined_1yr_ago", "X2021_combined_5yr_ago")

#run function.subtract_same_as_in_YYYY_column on dataframes in the combined list
df.combined_by_LGA.list <- lapply(df.combined_by_LGA.list, function(x) {function.subtract_same_as_in_YYYY_column(x)})
names(df.combined_by_LGA.list) <- c("X2016_combined_1yr_ago", "X2016_combined_5yr_ago", "X2021_combined_1yr_ago", "X2021_combined_5yr_ago")

#remove Elsewhere in Australia column
df.combined_by_LGA.list <- lapply(df.combined_by_LGA.list, function(x){cbind(x[1:2],x[4:93])
  })



#push results of list back out to global environment
invisible(list2env(df.combined_by_LGA.list,envir=.GlobalEnv))

library(janitor)
knitr::kable(
  head(X2016_combined_1yr_ago[,1:8]), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrr", caption = 'Table 4: 2016 census, place of usual residence 1 year ago combined table,first 6 results for first 8 columns')


#knitr::kable(
#  head(rowSums(X2016_combined_1yr_ago[,2:ncol(X2016_combined_1yr_ago)])), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrr", caption = 'Table 4a: 2016 census, place of usual residence 1 year ago combined table, first 6 results for first 8 columns')
###Just checking totals again.  All good as Apline total (12,256) matches (plus minus the randomisation issues) the Table 3a total of 12,331)




```

Finally, four more datasets^[8+4+4=16] were extracted for states and territories that are not Victoria^[The rest of Australia, being New South Wales, Queensland etc.] for people moving from Victorian LGAs one and five years before each of the 2016 and 2021 censuses. These datasets a needed to be able to calculate the regions that people resident in Victorian LGAS in 2011, 2015, 2016 and 2021 moved to, allowing analysis of residential relocation from the inner, middle, outer, peri-urban and rest of Victoria regions^[Note, that it is not possible to include analysis of people who moved from Victorian LGAs to places overseas, as these people are not in the census data. But, at least this analysis can consider residential relocation FROM our regions of interest TO other places in (all of) Australia.].


```{r loadsurveydata_rest_of_australia, echo=FALSE, warning = FALSE, message = FALSE, include = TRUE} 
#Load datasets
library(readr)
X2016_1yr_ago_rest_of_Australia_to_Vic_LGA <- read_csv("01 data/2016_1yr_ago_rest_of_Australia_to_Vic_LGA.csv", skip = 8)
X2016_5yr_ago_rest_of_Australia_to_Vic_LGA <- read_csv("01 data/2016_5yr_ago_rest_of_Australia_to_Vic_LGA.csv", skip = 9)
X2021_1yr_ago_rest_of_Australia_to_Vic_LGA <- read_csv("01 data/2021_1yr_ago_rest_of_Australia_to_Vic_LGA.csv", skip = 9)
X2021_5yr_ago_rest_of_Australia_to_Vic_LGA <- read_csv("01 data/2021_5yr_ago_rest_of_Australia_to_Vic_LGA.csv", skip = 9)


#delete empty first rows from each table
X2016_1yr_ago_rest_of_Australia_to_Vic_LGA <- X2016_1yr_ago_rest_of_Australia_to_Vic_LGA[-1,]
X2016_5yr_ago_rest_of_Australia_to_Vic_LGA <- X2016_5yr_ago_rest_of_Australia_to_Vic_LGA[-1,]
X2021_1yr_ago_rest_of_Australia_to_Vic_LGA <- X2021_1yr_ago_rest_of_Australia_to_Vic_LGA[-1,]
X2021_5yr_ago_rest_of_Australia_to_Vic_LGA <- X2021_5yr_ago_rest_of_Australia_to_Vic_LGA[-1,]

#delete empty last column from each table
#delete total column from each table
#also delete Not Stated, and Not Applicable; from State tables
#also delete: Capital City Undefined (Greater Melbourne),	Unincorporated Vic,	No Usual Address (Vic.),	Migratory - Offshore - Shipping (Vic.), and	State Undefined (Vic.); from LGA tables
#delete last 5 rows from each table (the totals and ABS details)
X2016_1yr_ago_rest_of_Australia_to_Vic_LGA <- X2016_1yr_ago_rest_of_Australia_to_Vic_LGA[1:(nrow(X2016_1yr_ago_rest_of_Australia_to_Vic_LGA)-5),1:(ncol(X2016_1yr_ago_rest_of_Australia_to_Vic_LGA)-7)]
X2016_5yr_ago_rest_of_Australia_to_Vic_LGA <- X2016_5yr_ago_rest_of_Australia_to_Vic_LGA[1:(nrow(X2016_5yr_ago_rest_of_Australia_to_Vic_LGA)-9),1:(ncol(X2016_5yr_ago_rest_of_Australia_to_Vic_LGA)-6)]
X2021_1yr_ago_rest_of_Australia_to_Vic_LGA <- X2021_1yr_ago_rest_of_Australia_to_Vic_LGA[1:(nrow(X2021_1yr_ago_rest_of_Australia_to_Vic_LGA)-8),1:(ncol(X2021_1yr_ago_rest_of_Australia_to_Vic_LGA)-6)]
X2021_5yr_ago_rest_of_Australia_to_Vic_LGA <- X2021_5yr_ago_rest_of_Australia_to_Vic_LGA[1:(nrow(X2021_5yr_ago_rest_of_Australia_to_Vic_LGA)-8),1:(ncol(X2021_5yr_ago_rest_of_Australia_to_Vic_LGA)-6)]

#Convert second column to numeric, as it is a character for some reason
X2016_1yr_ago_rest_of_Australia_to_Vic_LGA[,2] <- as.numeric(unlist(X2016_1yr_ago_rest_of_Australia_to_Vic_LGA[,2]))
X2016_5yr_ago_rest_of_Australia_to_Vic_LGA[,2] <- as.numeric(unlist(X2016_5yr_ago_rest_of_Australia_to_Vic_LGA[,2]))
X2021_1yr_ago_rest_of_Australia_to_Vic_LGA[,2] <- as.numeric(unlist(X2021_1yr_ago_rest_of_Australia_to_Vic_LGA[,2]))
X2021_5yr_ago_rest_of_Australia_to_Vic_LGA[,2] <- as.numeric(unlist(X2021_5yr_ago_rest_of_Australia_to_Vic_LGA[,2]))




#change name of first column in all dataframes to Location
df.rest_of_australia.list <- list(
  X2016_1yr_ago_rest_of_Australia_to_Vic_LGA, 
  X2016_5yr_ago_rest_of_Australia_to_Vic_LGA,
  X2021_1yr_ago_rest_of_Australia_to_Vic_LGA,
  X2021_5yr_ago_rest_of_Australia_to_Vic_LGA)
df.rest_of_australia.list <- lapply(df.rest_of_australia.list, function(x) {colnames(x)[1] = "Location"; x})
names(df.rest_of_australia.list) <- c("X2016_1yr_ago_rest_of_Australia_to_Vic_LGA", 
                "X2016_5yr_ago_rest_of_Australia_to_Vic_LGA", 
                "X2021_1yr_ago_rest_of_Australia_to_Vic_LGA",
                "X2021_5yr_ago_rest_of_Australia_to_Vic_LGA")
invisible(list2env(df.rest_of_australia.list,envir=.GlobalEnv))


knitr::kable(
  head(X2016_1yr_ago_rest_of_Australia_to_Vic_LGA[,1:6]), format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrr", caption = 'Table 5: 2016 census, LGA of residence one year before census for those who moved to Victoria, results by State and Territory for non-Victorian locations, first 6 results and first 6 LGAs')
```

  
# 3.0 Regions
Inner, middle and outer regions were defined in the 2020 Melbourne COVID-19 survey, as shown in Table 6. The additional zones of Peri-Urban Area and Rest of Victoria have been defined in the work to date for the forthcoming Regional Victoria COVID-19 survey, and Table 6 also shows allocation of LGAs to those zones as well^[Note that the Peri-Urban Area and Rest of Victoria zones have actually been defined using the Statistical Area 3 (SA3) boundaries. These are slightly different to LGA boundaries, so LGAs have been assigned to one of the Peri-Urban Area and Rest of Victoria regions by inspection.]. 

```{r loadregions, echo=FALSE, warning=FALSE, message=FALSE, include = TRUE} 
#Load dataset
library(readr)
region <- read_csv("01 data/region.csv")

knitr::kable(head(region, n=15), caption = 'Table 6: Victorian LGAs by region, first 15 entries')
```

# 4.0 Results 
The raw data from the ABS table builder (Table 4) and the allocation of LGAs to each region (Table 6) have been combined. This results in tables of usual address 1 or 5 years ago, by region. Results are summarised in Tables 7-10^[Note, the 'not stated' and 'not applicable' fields have been dropped.].  


```{r by_region_inner_middle_etc, echo=FALSE, warning=FALSE, message=FALSE, include = TRUE} 
#This section of code creates a list of dataframes with the complete details by region (inner, middle, outer, peri-urban, rest of vic, nsw, qld etc.)

#First join the dataframe of regions with each of the dataframes in the list of combined dataframes
df.combined_by_LGA.list <- lapply(df.combined_by_LGA.list, function(X) {merge(region, X)})
#return combined dataframes out of list
invisible(list2env(df.combined_by_LGA.list,envir=.GlobalEnv))

#Now obtain the position of inner, middle etc LGAs in the dataframes (ie row/column numbers)
LGAs_inner_position <- which(region$Region == "Inner")
LGAs_middle_position <- which(region$Region == "Middle")
LGAs_outer_position <- which(region$Region == "Outer")
LGAs_peri_urban_position <- which(region$Region == "Peri-Urban Area")
LGAs_rest_of_vic_position <- which(region$Region == "Rest of Victoria")


#Next collect all inner rows, and add them together
library(janitor)
df.inner.list <- lapply(df.combined_by_LGA.list, function(X) {
  X <- X[LGAs_inner_position,]})
df.inner.list <- lapply(df.inner.list, function(X) {
  X <- X %>% adorn_totals("row")})
df.inner.list <- lapply(df.inner.list, function(X) {
  X[[nrow(X),1]] <- "Inner"
  return(X)
  })


#Next collect all middle rows, and add them together
library(janitor)
df.middle.list <- lapply(df.combined_by_LGA.list, function(X) {
  X <- X[LGAs_middle_position,]})
df.middle.list <- lapply(df.middle.list, function(X) {
  X <- X %>% adorn_totals("row")})
df.middle.list <- lapply(df.middle.list, function(X) {
  X[[nrow(X),1]] <- "Middle"
  return(X)
  })


#Next collect all outer rows, and add them together
library(janitor)
df.outer.list <- lapply(df.combined_by_LGA.list, function(X) {
  X <- X[LGAs_outer_position,]})
df.outer.list <- lapply(df.outer.list, function(X) {
  X <- X %>% adorn_totals("row")})
df.outer.list <- lapply(df.outer.list, function(X) {
  X[[nrow(X),1]] <- "Outer"
  return(X)
  })


#Next collect all peri_urban rows, and add them together
library(janitor)
df.peri_urban.list <- lapply(df.combined_by_LGA.list, function(X) {
  X <- X[LGAs_peri_urban_position,]})
df.peri_urban.list <- lapply(df.peri_urban.list, function(X) {
  X <- X %>% adorn_totals("row")})
df.peri_urban.list <- lapply(df.peri_urban.list, function(X) {
  X[[nrow(X),1]] <- "Peri-Urban Areas"
  return(X)
  })


#Next collect all rest_of_vic rows, and add them together
library(janitor)
df.rest_of_vic.list <- lapply(df.combined_by_LGA.list, function(X) {
  X <- X[LGAs_rest_of_vic_position,]})
df.rest_of_vic.list <- lapply(df.rest_of_vic.list, function(X) {
  X <- X %>% adorn_totals("row")})
df.rest_of_vic.list <- lapply(df.rest_of_vic.list, function(X) {
  X[[nrow(X),1]] <- "Rest of Victoria"
  return(X)
  })


#Then collect the Inner, middle, outer etc totals from each list and combine into one list of dataframes
#By firest creating df.lists of just the "Total" rows from each
df.inner_total.list <- lapply(df.inner.list, tail, 1)
df.middle_total.list <- lapply(df.middle.list, tail, 1)
df.outer_total.list <- lapply(df.outer.list, tail, 1)
df.peri_urban_total.list <- lapply(df.peri_urban.list, tail, 1)
df.rest_of_vic_total.list <- lapply(df.rest_of_vic.list, tail, 1)
#Then combining them
df.combined_by_region.list <- mapply(rbind, df.inner_total.list, df.middle_total.list, df.outer_total.list, df.peri_urban_total.list, df.rest_of_vic_total.list, SIMPLIFY = FALSE)

####Next, work on combining the columns
#Next collect all inner columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.inner_columns.list <- lapply(df.combined_by_region.list, function(X) {
  X <- X[,LGAs_inner_position+7]})
df.inner_columns.list <- lapply(df.inner_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.inner_columns.list <- lapply(df.inner_columns.list, rename, Inner = Total)
  
#Next collect all middle columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.middle_columns.list <- lapply(df.combined_by_region.list, function(X) {
  X <- X[,LGAs_middle_position+7]})
df.middle_columns.list <- lapply(df.middle_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.middle_columns.list <- lapply(df.middle_columns.list, rename, Middle = Total)
  
#Next collect all outer columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.outer_columns.list <- lapply(df.combined_by_region.list, function(X) {
  X <- X[,LGAs_outer_position+7]})
df.outer_columns.list <- lapply(df.outer_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.outer_columns.list <- lapply(df.outer_columns.list, rename, Outer = Total)
  
#Next collect all peri_urban columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.peri_urban_columns.list <- lapply(df.combined_by_region.list, function(X) {
  X <- X[,LGAs_peri_urban_position+7]})
df.peri_urban_columns.list <- lapply(df.peri_urban_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.peri_urban_columns.list <- lapply(df.peri_urban_columns.list, rename, "Peri-Urban Area" = Total)
  
#Next collect all rest_of_vic columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.rest_of_vic_columns.list <- lapply(df.combined_by_region.list, function(X) {
  X <- X[,LGAs_rest_of_vic_position+7]})
df.rest_of_vic_columns.list <- lapply(df.rest_of_vic_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.rest_of_vic_columns.list <- lapply(df.rest_of_vic_columns.list, rename, "Rest of Victoria" = Total)
  


#Then collect the Inner, middle, outer etc totals from each list and combine into one list of dataframes
#By first creating df.lists of just the "Total" columns from each
library(tidyverse)
df.inner_columns_total.list <- lapply(df.inner_columns.list, function(x){x %>% select(last_col())})
df.middle_columns_total.list <- lapply(df.middle_columns.list, function(x){x %>% select(last_col())})
df.outer_columns_total.list <- lapply(df.outer_columns.list, function(x){x %>% select(last_col())})
df.peri_urban_columns_total.list <- lapply(df.peri_urban_columns.list, function(x){x %>% select(last_col())})
df.rest_of_vic_columns_total.list <- lapply(df.rest_of_vic_columns.list, function(x){x %>% select(last_col())})
#Then combining them
df.combined_by_region_columns.list <- mapply(cbind, df.inner_columns_total.list, df.middle_columns_total.list, df.outer_columns_total.list, df.peri_urban_columns_total.list, df.rest_of_vic_columns_total.list, SIMPLIFY = FALSE)


#Make new list of dataframes for aggregated by region. 
#first combine dataframes
df.combined_by_region.list <- mapply(cbind, df.combined_by_region.list, df.combined_by_region_columns.list, SIMPLIFY = FALSE)

#then drop repeated columns
df.combined_by_region.list <- lapply(df.combined_by_region.list, function(x){cbind(x[1],x[3], x[94:98], x[86:93], x[4])
 })

#rename first column as Region instead of LGA
df.combined_by_region.list <- lapply(df.combined_by_region.list, rename, "Region" = "LGA")

#Add total row and column
#df.combined_by_region.list <- lapply(df.combined_by_region.list, function(X) {
# X <- X %>% adorn_totals(c("row","col"))})

#Export back to Global Environment  
names(df.combined_by_region.list) <- c("X2016_combined_1yr_ago", "X2016_combined_5yr_ago", "X2021_combined_1yr_ago", "X2021_combined_5yr_ago")
invisible(list2env(df.combined_by_region.list,envir=.GlobalEnv))

knitr::kable(
 X2016_combined_1yr_ago %>% adorn_totals(c("row","col")) %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(X2016_combined_1yr_ago %>% adorn_totals(c("row","col")), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrrrrrrrrr", caption = 'Table 7: 2016 census, Usual address one year ago, by region')

knitr::kable(
 X2021_combined_1yr_ago %>% adorn_totals(c("row","col")) %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(X2021_combined_1yr_ago %>% adorn_totals(c("row","col")), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrrrrrrrrr", caption = 'Table 8: 2021 census, Usual address one year ago, by region')

knitr::kable(
 X2016_combined_5yr_ago %>% adorn_totals(c("row","col")) %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(X2016_combined_5yr_ago %>% adorn_totals(c("row","col")), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrrrrrrrrr", caption = 'Table 9: 2016 census, Usual address five years ago, by region')

knitr::kable(
 X2021_combined_5yr_ago %>% adorn_totals(c("row","col")) %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(X2021_combined_5yr_ago %>% adorn_totals(c("row","col")), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrrrrrrrrr", caption = 'Table 10: 2021 census, Usual address five years ago, by region')

```

Tables 7-10 have a large amount of data, which makes comparison difficult. Hence, the following sections examine various components of the usual address one and five years ago results to identify significant changes between pre- and during-COVID home relocation. 

## 4.1 Residential relocation within the year before the census

### 4.1.1 From the inner region of Melbourne
The third columns of Tables 7-10 provide details of where people who where living in the inner region one and five years before the 2016 and 2021^[i.e. in 2011, 2015, 2016 and 2020] had moved to in 2016 and 2021, respectively. The second column, first row of each table shows the number of people who were living in the inner region and who did not move. Table 11 collects this data.


```{r moving_from_inner, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 1: Inner region: usual address one year before the census, by census", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 
moving_from_inner <- as_tibble(cbind(X2016_combined_1yr_ago[,1], X2016_combined_5yr_ago[,3], X2016_combined_1yr_ago[3], X2021_combined_5yr_ago[,3], X2021_combined_1yr_ago[,3]))

names(moving_from_inner) <- c("Destination", "2011-16", "2015-16", "2016-21", "2020-21")

#add same house row to top of table
moving_from_inner <- rbind(c(
  "Did not move", 
  X2016_combined_5yr_ago[2,2],
  X2016_combined_1yr_ago[2,2], 
  X2021_combined_5yr_ago[2,2], 
  X2021_combined_1yr_ago[2,2]),
  moving_from_inner)

moving_from_inner[,2:5] <- apply(moving_from_inner[,2:5], 2, function(x) as.numeric(as.character(x)))


#output table with percentages etc. 
knitr::kable(
 as.data.frame(moving_from_inner) %>% adorn_totals("row") %>% adorn_percentages("col") %>% adorn_pct_formatting() %>% adorn_ns(ns = format(as.data.frame(moving_from_inner) %>% adorn_totals("row"), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrr", caption = 'Table 11: Destinations of those moving FROM the Inner region to locations within Victoria prior to the census')


```

However, the 'Rest of Australia' data^[This was imported from the ABS data above, see Table 5] needs to be added as well, so that it is possible to see people who moved from inner to other parts of Australia. This revision is shown in Table 11. 

```{r moving_from_inner_rest_of_australia, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 1: Inner region: usual address one year before the census, by census", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 
#Combining the columns
#Next collect all inner columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.inner_columns.list <- lapply(df.rest_of_australia.list, function(X) {
  X <- as.data.frame(X[,LGAs_inner_position+1])})
df.inner_columns.list <- lapply(df.inner_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.inner_columns.list <- lapply(df.inner_columns.list, rename, Inner = Total)
  
#Next collect all middle columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.middle_columns.list <- lapply(df.rest_of_australia.list, function(X) {
  X <- X[,LGAs_middle_position+1]})
df.middle_columns.list <- lapply(df.middle_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.middle_columns.list <- lapply(df.middle_columns.list, rename, Middle = Total)
  
#Next collect all outer columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.outer_columns.list <- lapply(df.rest_of_australia.list, function(X) {
  X <- X[,LGAs_outer_position+1]})
df.outer_columns.list <- lapply(df.outer_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.outer_columns.list <- lapply(df.outer_columns.list, rename, Outer = Total)
  
#Next collect all peri_urban columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.peri_urban_columns.list <- lapply(df.rest_of_australia.list, function(X) {
  X <- X[,LGAs_peri_urban_position+1]})
df.peri_urban_columns.list <- lapply(df.peri_urban_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.peri_urban_columns.list <- lapply(df.peri_urban_columns.list, rename, "Peri-Urban Area" = Total)
  
#Next collect all rest_of_vic columns, and add them together
library(janitor)
library(dplyr)
library(purrr)
df.rest_of_vic_columns.list <- lapply(df.rest_of_australia.list, function(X) {
  X <- X[,LGAs_rest_of_vic_position+1]})
df.rest_of_vic_columns.list <- lapply(df.rest_of_vic_columns.list, function(X) {
  X <- X %>% adorn_totals("col")})
df.rest_of_vic_columns.list <- lapply(df.rest_of_vic_columns.list, rename, "Rest of Victoria" = Total)
  


#Then collect the Inner, middle, outer etc totals from each list and combine into one list of dataframes
#By first creating df.lists of just the "Total" columns from each
library(tidyverse)
df.inner_columns_total.list <- lapply(df.inner_columns.list, function(x){x %>% select(last_col())})
df.middle_columns_total.list <- lapply(df.middle_columns.list, function(x){x %>% select(last_col())})
df.outer_columns_total.list <- lapply(df.outer_columns.list, function(x){x %>% select(last_col())})
df.peri_urban_columns_total.list <- lapply(df.peri_urban_columns.list, function(x){x %>% select(last_col())})
df.rest_of_vic_columns_total.list <- lapply(df.rest_of_vic_columns.list, function(x){x %>% select(last_col())})
#Then combining them
df.combined_by_region_columns_rest_of_australia.list <- mapply(cbind, df.inner_columns_total.list, df.middle_columns_total.list, df.outer_columns_total.list, df.peri_urban_columns_total.list, df.rest_of_vic_columns_total.list, SIMPLIFY = FALSE)


#Make new list of dataframes for aggregated by region. 
#first combine dataframes
df.combined_by_regions_rest_of_australia.list <- mapply(cbind, df.rest_of_australia.list, df.combined_by_region_columns_rest_of_australia.list, SIMPLIFY = FALSE)

#then drop repeated columns
df.combined_by_regions_rest_of_australia.list <- lapply(df.combined_by_regions_rest_of_australia.list, function(x){cbind(x[1],x[81:85])
 })

#rename first column as Region instead of Location
df.combined_by_regions_rest_of_australia.list <- lapply(df.combined_by_regions_rest_of_australia.list, rename, "Region" = "Location")

#Export back to Global Environment  
names(df.combined_by_regions_rest_of_australia.list) <- names(df.rest_of_australia.list)
invisible(list2env(df.combined_by_regions_rest_of_australia.list,envir=.GlobalEnv))

#combine rest_of_Australia in the same format as moving_from_inner
moving_from_inner_rest_of_Australia <- cbind(
  X2016_5yr_ago_rest_of_Australia_to_Vic_LGA[,1:2],
  X2016_1yr_ago_rest_of_Australia_to_Vic_LGA[,2],
  X2021_5yr_ago_rest_of_Australia_to_Vic_LGA[,2],
  X2021_1yr_ago_rest_of_Australia_to_Vic_LGA[,2])
names(moving_from_inner_rest_of_Australia) <- names(moving_from_inner)

moving_from_inner <- as_tibble(rbind(moving_from_inner, moving_from_inner_rest_of_Australia))

#reorder columns so that 1 and 5 yr periods are next to each other
moving_from_inner <- cbind(
  moving_from_inner[,1], 
  moving_from_inner[,3], 
  moving_from_inner[,5],
  moving_from_inner[,2],
  moving_from_inner[,4])


#output table with percentages etc. 
knitr::kable(
 as.data.frame(moving_from_inner) %>% adorn_totals("row") %>% adorn_percentages("col") %>% adorn_pct_formatting() %>% adorn_ns(ns = format(as.data.frame(moving_from_inner) %>% adorn_totals("row"), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrr", caption = 'Table 11: Destinations of those moving FROM the Inner region to locations within Australia prior to the census')


```

Figure 1 compares the proportion of people who moved who were both resident in Australia in each census year^[i.e. people who moved from inner to overseas are excluded as they are not included in the census data.], and resident in the inner region one year earlier. 

```{r chi_square_did_not_move_from_inner_change_1_yr, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 1: Did or did not move residences in the year prior to the census, inner region (moving to destinations within Australia)", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 


library(gplots)
library(ggpubr)
#pivot moving_from_inner 1 year ago columns to be longer, so that it can be input into GGbarstats as a data table organised by counts
# exclude final row with "Other Territories" as the numbers are very small
moving_inner_yes_no_1yr_ago <- rbind(moving_from_inner[1,], (adorn_totals(moving_from_inner[2:14,], where = "row")[14,]))
moving_inner_yes_no_1yr_ago[2,1] <- "Moved"
moving_from_inner_1yr_ago.longer <- pivot_longer(moving_inner_yes_no_1yr_ago[,1:3], cols = 2:3, names_to = "Census", values_to = "People")

library(magrittr)
moving_from_inner_1yr_ago.longer$Destination %<>% factor
moving_from_inner_1yr_ago.longer$Destination <- factor(moving_from_inner_1yr_ago.longer$Destination, levels = c(
  "Did not move",
  "Moved"))

library(gginnards)  
library(ggstatsplot)
ggbarstats(
  data = moving_from_inner_1yr_ago.longer,
  x = Destination,
  y = Census,
  counts = People,
  label = "percentage",
  package = "ggsci",
  palette = "default_jco",
  caption = "Source: author analysis of ABS data",
  legend.title = "Destination",
)

library(prmisc)


```


A Person's chi-squared test indicated that the relationship between which census it was (2016 or 2021) and whether someone living in the inner region one year prior to the census moved in that year was significant `r  print_chi2(as.matrix(moving_inner_yes_no_1yr_ago[,2:3]))`. However, Figure 1 and Table 11 indicate that the actual amount of change in the porportion of people moving was only 0.2% (from 98.9% of inner residents not moving in 2015-16 to 98.7% in 2020-21). In general, there appears to have been a very slight increase in residential relocation from the inner region compared to pre-COVID, but this is small compared to the overall number of inner region residents. 

Table 12 and Figure 2 looks specifically at those who did move from the inner region within the year before each census^[And again, does not include those who moved overseas are there is no data avaiable on them.]. It compares the destinations of people moving away from the inner region of Melbourne to other places in Australia in the year prior to the 2016 and 2021 censuses. 

```{r chi_square_move_from_inner_change_1_yr, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 2: Residential relocation from the inner reigion in the year prior to the census, by destination", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 

knitr::kable(
 as.data.frame(moving_from_inner[2:13,1:3]) %>% adorn_totals("row") %>% adorn_percentages("col") %>% adorn_pct_formatting() %>% adorn_ns(ns = format(as.data.frame(moving_from_inner[2:13, 1:3]) %>% adorn_totals("row"), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrr", caption = 'Table 12: Destinations of those moving FROM the Inner region to locations within Australia in the year prior to the census, excluding other territories')


library(gplots)
library(ggpubr)
#pivot moving_from_inner 1 year ago columns to be longer, so that it can be input into GGbarstats as a data table organised by counts
# exclude final row with "Other Territories" as the numbers are very small
moving_from_inner_1yr_ago.longer <- pivot_longer(moving_from_inner[2:13,1:3], cols = 2:3, names_to = "Census", values_to = "People")

library(magrittr)
moving_from_inner_1yr_ago.longer$Destination %<>% factor
moving_from_inner_1yr_ago.longer$Destination <- factor(moving_from_inner_1yr_ago.longer$Destination, levels = c(
  "Did not move",
  "Inner",
  "Middle",
  "Outer", 
  "Peri-Urban Areas", 
  "Rest of Victoria", 
  "New South Wales", 
  "Queensland",
  "South Australia",
  "Tasmania",
  "Western Australia",
  "Northern Territory",
  "Australian Capital Territory"))

library(gginnards)  
library(ggstatsplot)
p <- ggbarstats(
  data = moving_from_inner_1yr_ago.longer,
  x = Destination,
  y = Census,
  counts = People,
  label = "percentage",
  package = "ggsci",
  palette = "default_jco",
  caption = "Source: author analysis of ABS data",
  legend.title = "Destination",
)
delete_layers(p, "GeomLabel")
library(prmisc)


```

A Person's chi-squared test indicated that the relationship between which census it was (2016 or 2021) and where someone who moved from the inner region in the year prior to the census was significant `r  print_chi2(as.matrix(moving_from_inner[2:13,2:3]))`. Figure 1 and Table 11 indicate that:

* In 2020-21 45% of residential relocation from the inner region of Melbourne was to the outer region, compared to 55% in 2015-16,
* In 2020-21 11% of residential relocation from the inner region of Melbourne was to the Queensland, almost twice as much as the 6%% in 2015-16.

In short, it appears that, compared to pre-COVID, a higher proportion of those moving from the inner region of Melbourne are relocating TO Queensland, while a lower proportion are moving TO the outer areas of Melbourne. 


NEXT STEPS
REPEAT ABOVE FOR MIDDLE AND OUTER REGIONS








### 4.1.2 To the inner region of Melbourne
Figure 1 compares the rates of living in the same address as one year ago  for the inner region between the 2016 and 2021 censuses.  

```{r chi_square_inner_change_1_yr, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 1: Inner region: usual address one year before the census, by census", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 


#First extra Inner Regions from 2016 and 2021 tables and combine into a single contingency table
#but first they all need to have the same column names
colnames(X2016_combined_1yr_ago)[2] <- "Same address"
colnames(X2021_combined_1yr_ago)[2] <- "Same address"
colnames(X2016_combined_1yr_ago)[16] <- "Overseas"
colnames(X2021_combined_1yr_ago)[16] <- "Overseas"
names(X2016_combined_1yr_ago) <- names(X2021_combined_1yr_ago)
#combined table
inner_2016_2021_1yr_ago <- rbind(X2016_combined_1yr_ago[1,], X2021_combined_1yr_ago[1,])
#change first column so that it shows the correct descriptions
inner_2016_2021_1yr_ago[,1] <- c("2016", "2021") 
colnames(inner_2016_2021_1yr_ago)[1] <- "Census"

#combine other states and territories of Australia into Rest_of_Australia variable
inner_2016_2021_1yr_ago <- cbind(inner_2016_2021_1yr_ago[1:7], rowSums(inner_2016_2021_1yr_ago[8:15]),inner_2016_2021_1yr_ago[16])
colnames(inner_2016_2021_1yr_ago)[8] <- "Rest of Australia"

#output table with percentages etc. 
knitr::kable(
 inner_2016_2021_1yr_ago %>% adorn_totals("col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(inner_2016_2021_1yr_ago %>% adorn_totals("col"), big.mark=","), position = "front"), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE), align = "lrrrrrrrrr", caption = 'Table 11: Inner region: usual address one year before the census, by census')

library(gplots)
library(ggpubr)
#pivot inner_2016_2021 to be longer, so that it can be input into GGbarstats as a data table organised by counts
inner_2016_2021_1yr_ago.longer <- pivot_longer(inner_2016_2021_1yr_ago, cols = 2:ncol(inner_2016_2021_1yr_ago), names_to = "Residence 1 yr ago", values_to = "People")

library(magrittr)
inner_2016_2021_1yr_ago.longer$`Residence 1 yr ago` %<>% factor
inner_2016_2021_1yr_ago.longer$`Residence 1 yr ago` <- factor(inner_2016_2021_1yr_ago.longer$`Residence 1 yr ago`, levels = c("Same address", "Inner", "Middle", "Outer", "Peri-Urban Area", "Rest of Victoria", "Rest of Australia", "Overseas"))
       

library(gginnards)  
library(ggstatsplot)
p <- ggbarstats(
  data = inner_2016_2021_1yr_ago.longer,
  x = "Residence 1 yr ago",
  y = Census,
  counts = People,
  label = "percentage",
  package = "ggsci",
  palette = "default_jama",
  caption = "Source: author analysis of ABS data",
  legend.title = "Place of residence one year before census",
)
delete_layers(p, "GeomLabel")
library(prmisc)
```

A Person's chi-squared test indicated that the relationship between which census it was (2016 or 2021) and where someone in the inner region lived one year before the census was significat `r  print_chi2(as.matrix(inner_2016_2021_1yr_ago[,2:9]))`. From the bar chart shown in Figure 10 and the percentages in Table 1, it appears that the largest changes between the 2016 and 2021 censuses are in the percentage of people who were overseas one year earlier (7.4% versus 2.0%). The following examines each of the categories in turn. 


```{r chi_square_inner_change_1_yr_same_address, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 2: Inner region: usual address one year before the census, by census", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 

  df <- cbind(inner_2016_2021_1yr_ago[1], inner_2016_2021_1yr_ago[2], rowSums(inner_2016_2021_1yr_ago[2:9])-inner_2016_2021_1yr_ago[2])
  colnames(df)[3] <- "Other"

  #output table with percentages etc. 
knitr::kable(
   df %>% adorn_totals("col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(df %>% adorn_totals("col"), big.mark=","), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE)), align = "lrrr", caption = 'Table 12: Inner region: usual address one year before the census, by census')
#pivot inner_2016_2021 to be longer, so that it can be input into GGbarstats as a data table organised by counts
df.longer <- pivot_longer(df, cols = 2:ncol(df), names_to = "Residence 1 yr ago", values_to = "People")

ggbarstats(
  data = df.longer,
  x = "Residence 1 yr ago",
  y = Census,
  counts = People,
  label = "percentage",
  package = "ggsci",
  palette = "default_jama",
  caption = "Source: author analysis of ABS data",
  legend.title = "Place of residence one year before census",
)




```


A Person's chi-squared test indicated that the relationship between which census it was (2016 or 2021) and whether someone in the inner region had the same address as a year ago was significant `r  print_chi2(as.matrix(df[,2:3]))`. As shown in Figure 2 and Table 12, almost 71% of inner residents in 2016 had the same address as in 2015, whereas only a little over 69% had the same address in 2021 as in 2020.




```{r chi_square_inner_change_1_yr_previous_address, fig.fullwidth=TRUE, fig.margin = FALSE, fig.cap= "Figure 3: Inner region: usual address one year before the census for those who had moved, by census", fig.height=4, warning=FALSE, echo=FALSE, message = FALSE, show_col_types = FALSE} 

  df <- cbind(inner_2016_2021_1yr_ago[1], inner_2016_2021_1yr_ago[3:9])


  #output table with percentages etc. 
knitr::kable(
   df %>% adorn_totals("col") %>% adorn_percentages() %>% adorn_pct_formatting() %>% adorn_ns(ns = format(df %>% adorn_totals("col"), big.mark=","), row.names = FALSE, format.args = list(big.mark = ",", scientific = FALSE)), align = "lrrr", caption = 'Table 13: Inner region: usual address one year before the census for those who had moved, by census')
#pivot inner_2016_2021 to be longer, so that it can be input into GGbarstats as a data table organised by counts
df.longer <- pivot_longer(df, cols = 2:ncol(df), names_to = "Residence 1 yr ago", values_to = "People")

library(magrittr)
df.longer$`Residence 1 yr ago` %<>% factor
df.longer$`Residence 1 yr ago` <- factor(df.longer$`Residence 1 yr ago`, levels = c("Inner", "Middle", "Outer", "Peri-Urban Area", "Rest of Victoria", "Rest of Australia", "Overseas"))

p <- ggbarstats(
  data = df.longer,
  x = "Residence 1 yr ago",
  y = Census,
  counts = People,
  label = "percentage",
  package = "ggsci",
  palette = "default_jama",
  caption = "Source: author analysis of ABS data",
  legend.title = "Place of residence one year before census",
)

delete_layers(p, "GeomLabel")


```


A Person's chi-squared test indicated that the relationship between which census it was (2016 or 2021) and where someone in the inner region who had a different address to a year ago was significant `r  print_chi2(as.matrix(df[,2:8]))`. As shown in Figure 3 and Table 13, in 2016 of those people who had moved to the inner region since 2015: 33% had moved from ther rest of Victoria, 25% from overseas, 21% from the outer parts of Melbourne and 10% from the rest of Australia. In contrast, in 2021 of those people who had moved to the inner region since 2020: 41% had moved from the rest of Victoria, 29% from outer Melbourne and only 6% from overseas.

In summary, for those living in the inner region of Melbourne the census data suggests that:

* there was a small, but significant, increase in the proportion of people who had changed address in the previous year in 2021 (31%) compared to 2016 (29%).
* for those who had changed address in the previous year in 2021 the proportion of people was: 
  + largest for those had moved from the rest of Victoria (41%), followed by,
  + those moving from the outer parts of Melbourne (29%), 
  + the rest of Australia (9%), 
  + the peri-urban area of Victoria (9%), 
  + overseas (7%), 
  + the middle suburbs (6%), and with those moving 
  + from another residence within the inner part of Melbourne consisting of the smallest proportion (<1%) of those who had moved in the previous year. In contrast, 
* in 2016 the proportion of people was: 
  + largest for those had moved from the rest of Victoria (33%), followed by,
  + those moving from overseas (25%), 
  + the outer parts of Melbourne (21%), 
  + the rest of Australia (10%), 
  + the peri-urban area of Victoria (6%), 
  + the middle suburbs (4%), and with those moving 
  + from another residence within the inner part of Melbourne again being the smallest proportion (<1%). 

Hence, the biggest changes appears to be the reduction of the proportion of people moving to inner Melbourne from overseas (down by 18%), and increases in the proportion of people moving from outer Melbourne and from the rest of Victoria (both up by 8%).

